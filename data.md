# Dataverseテーブル設計詳細ガイド

## 1. テーブル構成概要

### 1.1 エンティティ分類

| 分類 | テーブル | 主要目的 |
|------|----------|----------|
| **コアエンティティ** | cr_faq, cr_category | FAQ管理の中核機能 |
| **ユーザー管理** | systemuser, cr_userrole | 認証・認可・権限管理 |
| **機能拡張** | cr_faqtag, cr_faqrating | FAQ付加機能 |
| **ワークフロー** | cr_faqapproval | 承認プロセス管理 |
| **分析・ログ** | cr_faqview, cr_searchlog | 利用状況分析 |
| **システム管理** | cr_systemsetting, cr_notification | システム運用 |

### 1.2 命名規則

```yaml
プレフィックス: cr_ (Custom Relationship)
テーブル名: 英語、小文字、アンダースコア区切り
カラム名: テーブル名プレフィックス + カラム名
主キー: テーブル名 + id
外部キー: 参照テーブル名 + id (cr_は除去)
```

## 2. 中核エンティティ詳細設計

### 2.1 cr_faq（FAQテーブル）

**設計思想**: FAQ情報の統合管理とSharePoint連携

```sql
主要設計ポイント:
├── 構造化データ: Dataverseで管理（メタデータ、ステータス）
├── 非構造化データ: SharePointで管理（本文、添付ファイル）
├── ハイブリッド構造: 検索性能と柔軟性の両立
└── バージョン管理: SharePointのバージョン機能活用
```

**重要カラム解説**:

| カラム名 | データ型 | 用途 | 設計考慮点 |
|----------|----------|------|-----------|
| `cr_status` | Choice | 公開状態管理 | 下書き→承認待ち→公開→アーカイブ |
| `cr_sharepointurl` | Text | SharePoint連携 | FAQ詳細コンテンツへの直接リンク |
| `cr_rating` | Decimal | 品質管理 | 1-5スケール、平均値自動計算 |
| `cr_tags` | Text | 横断検索 | カンマ区切り、検索インデックス対象 |

**Choice値定義**:
```yaml
cr_status:
  - 100000000: 下書き
  - 100000001: 承認待ち
  - 100000002: 公開
  - 100000003: 非公開
  - 100000004: アーカイブ

cr_priority:
  - 100000000: 高
  - 100000001: 中
  - 100000002: 低
```

### 2.2 cr_category（カテゴリテーブル）

**設計思想**: 階層構造による柔軟な分類管理

```sql
階層構造の実装:
├── Self-Reference: cr_parentcategory（自己参照）
├── 表示制御: cr_displayorder（表示順序）
├── アイコン管理: cr_icon（視覚的識別）
└── 無効化対応: cr_isactive（論理削除）
```

**階層構造例**:
```
製品サポート (cr_parentcategory: null)
├── ソフトウェア (cr_parentcategory: 製品サポートID)
│   ├── インストール (cr_parentcategory: ソフトウェアID)
│   └── トラブルシューティング
└── ハードウェア
    ├── 設定
    └── 故障対応
```

## 3. ユーザー管理設計

### 3.1 systemuser（標準ユーザーテーブル）

**活用方針**: Dataverse標準のsystemuserテーブルを活用

```yaml
Azure AD統合:
├── 自動同期: Azure AD → Dataverse
├── 属性マッピング: 部署、役職、連絡先
├── セキュリティ: Azure ADグループベース権限
└── プロビジョニング: 自動ユーザー作成・無効化
```

### 3.2 cr_userrole（カスタムロールテーブル）

**設計思想**: きめ細かな権限制御とカテゴリベース管理

```sql
ロール設計:
├── 階層型権限: システム管理者 > コンテンツ管理者 > 編集者 > 閲覧者
├── カテゴリ権限: カテゴリ別の編集・承認権限
├── 承認権限: cr_canapprove フラグ
└── 期限管理: 有効期限・自動無効化
```

**権限マトリクス**:

| ロール | FAQ作成 | FAQ編集 | FAQ削除 | FAQ承認 | カテゴリ管理 |
|--------|---------|---------|---------|---------|-------------|
| システム管理者 | ✅ | ✅ | ✅ | ✅ | ✅ |
| コンテンツ管理者 | ✅ | ✅ | ✅ | ✅ | 部分的 |
| 編集者 | ✅ | 自分のみ | 自分のみ | ❌ | ❌ |
| 閲覧者 | ❌ | ❌ | ❌ | ❌ | ❌ |

## 4. 機能拡張テーブル

### 4.1 タグ管理（cr_faqtag）

**設計選択**: 正規化 vs 非正規化

```yaml
選択理由: 正規化設計
メリット:
  - タグの一元管理・統計
  - タグ別検索の高速化
  - タグクラウド生成
  - 同義語管理

実装考慮点:
  - FAQ削除時のカスケード削除
  - タグ検索インデックス最適化
  - 人気タグランキング
```

### 4.2 評価管理（cr_faqrating）

**分析活用**: FAQ品質向上のためのフィードバックループ

```sql
評価データ活用:
├── 品質管理: 低評価FAQの改善優先度決定
├── 検索ランキング: 評価スコアによる検索結果最適化
├── レコメンド: 高評価FAQの推奨表示
└── 分析レポート: カテゴリ別品質ダッシュボード
```

## 5. ワークフロー設計

### 5.1 承認プロセス（cr_faqapproval）

**多段階承認対応**: 組織構造に応じた柔軟な承認フロー

```yaml
承認フロー例:
ステップ1: 作成者が承認申請
ステップ2: 部署管理者が一次承認
ステップ3: コンテンツ管理者が最終承認
ステップ4: 自動公開・通知

状態管理:
- 100000000: 申請中
- 100000001: 一次承認済
- 100000002: 最終承認済
- 100000003: 却下
- 100000004: 取り下げ
```

**Power Automate連携**:
```yaml
トリガー: cr_faqapproval レコード作成
処理:
  1. 承認者決定（部署・カテゴリベース）
  2. Teams通知・メール送信
  3. 承認結果反映
  4. FAQ状態更新
  5. 関係者通知
```

## 6. 分析・ログ設計

### 6.1 検索ログ（cr_searchlog）

**検索体験向上**: 検索失敗パターンの分析と改善

```sql
分析観点:
├── 検索キーワード分析: 頻出キーワード、失敗キーワード
├── 検索結果品質: ゼロヒット率、クリック率
├── ユーザー行動: 検索→閲覧→評価のパス分析
└── 改善提案: 新規FAQ作成候補、既存FAQ改善点
```

### 6.2 閲覧ログ（cr_faqview）

**利用状況分析**: FAQの効果測定とコンテンツ最適化

```sql
KPI計測:
├── 閲覧数: FAQ別、カテゴリ別、期間別
├── 滞在時間: コンテンツ品質の指標
├── 離脱率: FAQ解決率の推定
└── アクセス傾向: 時間帯、デバイス、部署別
```

## 7. インデックス戦略

### 7.1 検索性能最適化

```sql
-- 主要インデックス設計
CREATE INDEX idx_faq_status_category ON cr_faq (cr_status, cr_category);
CREATE INDEX idx_faq_publishdate_desc ON cr_faq (cr_publishdate DESC);
CREATE INDEX idx_faq_rating_desc ON cr_faq (cr_rating DESC);
CREATE INDEX idx_faq_viewcount_desc ON cr_faq (cr_viewcount DESC);
CREATE INDEX idx_searchlog_keyword ON cr_searchlog (cr_keyword);
CREATE INDEX idx_faqview_date_user ON cr_faqview (cr_viewdate, cr_userid);
```

### 7.2 Dataverse制約事項

```yaml
制約と対策:
├── インデックス制限: テーブル当たり最大20個
├── 複合インデックス: 最大16カラム
├── 文字列検索: Dataverse検索 + SharePoint検索の併用
└── 大量データ: アーカイブ戦略（1年以上の古いデータ）
```

## 8. セキュリティ実装

### 8.1 行レベルセキュリティ

```yaml
実装パターン:
├── 部署ベース: ユーザー部署 = FAQカテゴリ部署
├── ロールベース: 権限レベルによるデータアクセス制御
├── 作成者ベース: 自分が作成したFAQのみ編集可能
└── 公開状態ベース: 公開済みFAQのみ一般ユーザー閲覧可能
```

### 8.2 機密データ保護

```sql
機密レベル分類:
├── パブリック: 全ユーザー閲覧可能
├── 社内限定: 認証ユーザーのみ
├── 部署限定: 特定部署のみ
└── 管理者限定: システム・コンテンツ管理者のみ
```

## 9. 移行・初期データ設定

### 9.1 マスターデータ

```yaml
初期設定データ:
├── カテゴリ階層: 組織構造に基づく分類
├── ユーザーロール: 権限テンプレート
├── システム設定: 承認フロー、通知設定
└── 評価基準: 評価項目、スコア定義
```

### 9.2 既存データ移行

```yaml
移行戦略:
├── FAQデータ: CSV → Power Platform Data Import
├── ユーザーデータ: Azure AD同期
├── 権限設定: 手動設定 → 自動化
└── 履歴データ: 重要データのみ選択移行
```

## 10. 運用・保守考慮事項

### 10.1 データ品質管理

```yaml
品質維持施策:
├── 重複FAQ検知: タイトル・内容類似度チェック
├── 古いFAQ検出: 最終更新日ベースのアラート
├── 評価監視: 低評価FAQの改善通知
└── 利用状況監視: 非活用FAQの見直し提案
```

### 10.2 容量管理

```yaml
Dataverse容量最適化:
├── アーカイブ戦略: 古いログデータの定期削除
├── 添付ファイル: SharePoint移行によるDataverse負荷軽減
├── インデックス最適化: 利用状況に基づく見直し
└── 容量監視: 使用量アラート・拡張計画
```

この設計により、スケーラブルで保守性の高いFAQ管理システムのデータ基盤を構築できます。特にDataverseとSharePointのハイブリッド構造により、構造化データと非構造化データの最適な管理を実現しています。
